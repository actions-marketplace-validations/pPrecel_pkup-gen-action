name: 'PKUPgen'
description: 'Generate PKUP reports and send them to email addresses or/and save them'
inputs:
  generate:
    description: 'Generate reports'
    default: 'true'
    required: false
  create-tag:
    description: 'Create tag'
    default: 'true'
    required: false
  send-emails:
    description: 'Send emails'
    default: 'true'
    required: false
  since:
    description: 'Gen since (in format 02.01.2006)'
    default: ''
    required: false
  until:
    description: 'Gen until (in format 02.01.2006)'
    default: ''
    required: false
    
runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v4

  - name: Prerequisites
    shell: bash
    run: |
      echo "Installing pkup-gen cli..."
      curl "https://raw.githubusercontent.com/pPrecel/pkup-gen-action/main/scripts/install-pkup-gen.sh" | sh -

      echo "Installing yq..."
      curl "https://raw.githubusercontent.com/pPrecel/pkup-gen-action/main/scripts/install-yq.sh" | sh -

  - name: Generate reports
    if: ${{ github.event.inputs.generate == 'true'  }}
    shell: bash
    run: |
      rm -rf reports

      ARGS="--config .pkupcompose.yaml --ci"

      [ ! -z "${{ github.event.inputs.since }}" ] && ARGS="$ARGS --since ${{ github.event.inputs.since }}"
      [ ! -z "${{ github.event.inputs.until }}" ] && ARGS="$ARGS --until ${{ github.event.inputs.until }}"

      bin/pkup compose ${ARGS}

  - name: Create tag
    if: ${{ github.event.inputs.create-tag == 'true'  }}
    shell: bash
    run: |
      git config --local user.email "pkup-gen[bot]@pkup-gen.noreply.github.com"
      git config --local user.name "pkup-gen[bot]"

      git checkout -B $(date +"%m.%Y")

      git add reports
      git commit --allow-empty -m $(date +"%m.%Y")
      git push

      git tag -f $(date +"%m.%Y")

      git push -f origin $(date +"%m.%Y")
  
  - name: Send emails
    if: ${{ github.event.inputs.send-emails == 'true' }}
    shell: bash
    run: |
      ARGS="--config .pkupcompose.yaml"

      [ ! -z "${{ github.event.inputs.until }}" ] && ARGS="$ARGS --timestamp ${{ github.event.inputs.until }}"

      bin/pkup send ${ARGS}
  